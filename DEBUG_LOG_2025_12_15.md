# 调试日志 - 2025年12月15日

## 目标
针对 `SATA` 项目中的 `go2_jump_torque_min` 和 `go2_jump_pos_min` 任务，构建一个**严格控制变量**的实验环境，用于对比力矩控制与位置控制在**原地垂直跳跃**任务中的性能上限和物理特性。

解决训练过程中出现的“不跳”、“乱跳”、“翻车”、“关节着地”等问题，并确保两种控制方式使用相同的物理参数和奖励结构。

## 主要进展与调试过程

### 1. 环境与配置初始化
*   **新建实验目录**：`SATA/legged_gym/legged_gym/envs/go2/go2_jump_min_experiments/`。
*   **统一环境逻辑**：创建了 `go2_jump_min_env.py`，支持力矩 (`P_Residual`) 和位置 (`P`) 两种控制模式。
    *   **关键点**：两者使用**相同 PD 参数 (`Kp=20.0, Kd=0.5`)** 和 **物理等效的 `action_scale` (`Torque: 5.0, Position: 0.25`)**，确保控制变量唯一。
*   **新建配置文件**：`go2_jump_torque_min_config.py` 和 `go2_jump_pos_min_config.py`，并注册了对应任务。
*   **显存优化**：将 `num_envs` 从默认的 4096 调整为 **2048** 并使用 `--headless` 模式，解决了 Isaac Gym 的显存分配错误 (`PxgCudaDeviceMemoryAllocator fail`)。

### 2. 奖励函数迭代 (Reward Function Iteration)
*   **Phase 1: 极简奖励 (Minimal Rewards)**
    *   *设置*: 移除了所有物理性能限制（Torque/Vel/Acc 惩罚为 0），只保留 `base_height` (5.0, 目标 0.45m)。
    *   *结果*: 机器人选择**“踮脚站立”**，这是因为站立就能获得大部分高度奖励，且风险最低。
*   **Phase 2: 强制跳跃 (Forced Jumping)**
    *   *设置*: `base_height_target` 提高到 **0.80m** (站立不可达)；添加 `jump_velocity` (10.0) 和 `feet_air_time` (2.0)。
    *   *结果*: 机器人学会了“先趴下蓄力，跳得很高”，但空中姿态失控，经常翻车或摔倒，导致腾空奖励未结算。
*   **Phase 3: 稳定与定向激励 (Stabilization)**
    *   *设置*:
        *   **即时奖励**: 修改环境代码，让 `feet_air_time` 每一帧都结算，不再等待落地。
        *   **姿态约束**: 大幅提高 `orientation` (5.0) 和 `ang_vel_xy` (-0.05) 权重，严惩空中翻滚。
    *   *结果*: 机器人能起跳，但经常出现“膝盖着地”或“侧翻用屁股着地”而不终止的情况。
*   **Phase 4: 回归基础 (Back to Basics)**
    *   *最终设置*:
        *   `base_height_target` 调回 **0.40m** (正常站立高度)，让机器人能稳定准备和落地。
        *   主要依靠 **`jump_velocity` (10.0)** 驱动起跳，依靠 **`feet_air_time` (2.0)** 鼓励腾空。
        *   `tracking_lin_vel` (1.0) 和 `tracking_ang_vel` (1.0) 用于锁定水平位置，防止漂移。

### 3. 终止条件细化 (Termination Logic)
*   **问题**：观察到机器人“蓄力时膝盖跪地”或“跳起后翻车用背部着地”，但 Episode 未终止，导致机器人学会了错误的支撑策略。
*   **调试**：在 `__init__` 中加入 DEBUG 打印，确认了终止刚体索引已包含 `["base", "thigh", "calf"]`。
*   **最终修正**：为了最大限度严格，将 **除脚部 (`foot`) 之外的所有刚体** (base, hips, thighs, calves, head) 全部加入 `terminate_after_contacts_on` 列表。
*   **效果**：任何非脚部的触地都会立即触发 Termination，迫使机器人学会仅用脚部接触地面进行起跳和落地。

## 当前状态与下一步

*   **当前状态**：任务目标已锁定为**“原地垂直跳跃”**。在最严格的终止条件和高强度垂直激励下，机器人开始尝试跳跃，目前倾向于“把脚收在一起”以避免非法触地。
*   **下一步**：
    1.  继续训练 `go2_jump_torque_min`，观察其是否能收敛出稳定的跳跃步态。
    2.  启动 `go2_jump_pos_min` 训练，进行对比实验。
    3.  分析两者在**起跳爆发力**（Jump Velocity）、**腾空高度**（Base Height）和**落地稳定性**方面的差异。
